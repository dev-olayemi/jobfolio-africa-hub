rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helpers
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // -----------------------------
    // Profiles: public read, owner writes
    // -----------------------------
    match /profiles/{userId} {
      allow read: if true;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update, delete: if isSignedIn() && request.auth.uid == userId;
    }

    // -----------------------------
    // Folios & Subscriptions: owner-only
    // -----------------------------
    match /folios/{folioId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    match /subscriptions/{subId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // -----------------------------
    // Posts and comments (social feed)
    // - public read
    // - create only by authenticated user with matching authorId
    // - updates/deletes only by owner or admin
    // - comments: public read, create by signed-in users
    // -----------------------------
    match /posts/{postId} {
      allow read: if true;

      allow create: if isSignedIn()
        && request.resource.data.authorId == request.auth.uid
        && request.resource.data.content is string
        && request.resource.data.content.size() <= 4000
        && (request.resource.data.media == null || (request.resource.data.media is list && request.resource.data.media.size() <= 10));

      // disallow clients from directly manipulating counters (likesCount/commentsCount)
      // only post owner or admin may update the post document itself
      allow update: if isSignedIn() && (resource.data.authorId == request.auth.uid || isAdmin());

      allow delete: if isSignedIn() && (resource.data.authorId == request.auth.uid || isAdmin());

      match /comments/{commentId} {
        allow read: if true;
        allow create: if isSignedIn()
          && request.resource.data.authorId == request.auth.uid
          && request.resource.data.content is string
          && request.resource.data.content.size() <= 2000;
        allow update, delete: if isSignedIn() && (resource.data.authorId == request.auth.uid || isAdmin());
      }
    }

    // -----------------------------
    // Jobs
    // - public read for listing
    // - create by signed-in users (postedById must match)
    // - updates: only owner/admin (clients cannot directly set counters)
    // - allow safe view increment (only +1) to help lightweight view metrics
    // -----------------------------
    match /jobs/{jobId} {
      allow read: if true;

      allow create: if isSignedIn()
        && request.resource.data.postedById == request.auth.uid
        && request.resource.data.title is string
        && request.resource.data.title.size() <= 300
        && (request.resource.data.media == null || (request.resource.data.media is list && request.resource.data.media.size() <= 10));

      // Owner or admin may update job fields. Prevent clients from arbitrarily changing counters.
      allow update: if isSignedIn() && (resource.data.postedById == request.auth.uid || isAdmin())
        // OR allow a safe single increment to views by anyone (views must equal previous + 1)
        || (request.resource.data.keys().hasOnly(['views'])
            && request.resource.data.views is int
            && resource.data.views is int
            && request.resource.data.views == resource.data.views + 1
        );

      allow delete: if isSignedIn() && (resource.data.postedById == request.auth.uid || isAdmin());

      // likes as a subcollection: user may create/delete their own like doc.
      match /likes/{likeUserId} {
        allow create: if isSignedIn() && request.auth.uid == likeUserId && request.resource.data.userId == request.auth.uid;
        allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || likeUserId == request.auth.uid);
        allow delete: if isSignedIn() && (resource.data.userId == request.auth.uid || likeUserId == request.auth.uid);
      }

      // applications subcollection. Applicant may create and read their application.
      // Job owner may read/update application status. Admins may manage.
      match /applications/{applicationId} {
        allow create: if isSignedIn() && request.resource.data.applicantId == request.auth.uid
          && request.resource.data.jobId == jobId;

        allow read: if isSignedIn() && (
          resource.data.applicantId == request.auth.uid
          || get(/databases/$(database)/documents/jobs/$(jobId)).data.postedById == request.auth.uid
          || isAdmin()
        );

        allow update, delete: if isSignedIn() && (
          resource.data.applicantId == request.auth.uid
          || get(/databases/$(database)/documents/jobs/$(jobId)).data.postedById == request.auth.uid
          || isAdmin()
        );
      }
    }

    // -----------------------------
    // Generic collectionGroup rules for likes and applications
    // Allow users to create/delete their own likes/applications documents so they can
    // perform collectionGroup queries filtered by user. Parent owners or admins can read
    // applications for their resources via parent checks.
    // -----------------------------
    match /{parent=**}/likes/{likeId} {
      allow create: if isSignedIn() && (request.auth.uid == likeId || request.resource.data.userId == request.auth.uid);
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || likeId == request.auth.uid);
      allow delete: if isSignedIn() && (resource.data.userId == request.auth.uid || likeId == request.auth.uid);
    }

    match /{parent=**}/applications/{applicationId} {
      allow create: if isSignedIn() && request.resource.data.applicantId == request.auth.uid;
      allow read: if isSignedIn() && (
        resource.data.applicantId == request.auth.uid
        || (exists(/databases/$(database)/documents/$(parent)) && get(/databases/$(database)/documents/$(parent)).data.postedById == request.auth.uid)
        || isAdmin()
      );
      allow update, delete: if isSignedIn() && (
        resource.data.applicantId == request.auth.uid
        || (exists(/databases/$(database)/documents/$(parent)) && get(/databases/$(database)/documents/$(parent)).data.postedById == request.auth.uid)
        || isAdmin()
      );
    }

    // -----------------------------
    // Account approvals
    // -----------------------------
    match /accountApprovals/{approvalId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isSignedIn() && (request.auth.uid == resource.data.userId || isAdmin());
      allow update, delete: if isSignedIn() && isAdmin();
    }

    // -----------------------------
    // Notifications
    // - created only by server (admin SDK)
    // - recipient can read and mark read (update only the `read` boolean)
    // -----------------------------
    match /notifications/{notificationId} {
      allow create: if false; // server functions should create notifications with admin SDK
      allow read: if isSignedIn() && request.auth.uid == resource.data.to;
      // allow marking as read: only change the `read` field and only by recipient
      allow update: if isSignedIn() && request.auth.uid == resource.data.to
        && request.resource.data.keys().hasOnly(['read'])
        && request.resource.data.read is bool;
      allow delete: if false;
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
