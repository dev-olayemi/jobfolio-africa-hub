rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helpers
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // get a user's profile role safely
    function getRole(uid) {
      return exists(/databases/$(database)/documents/profiles/$(uid)) ? get(/databases/$(database)/documents/profiles/$(uid)).data.role : null;
    }

    function isCompanyOrAgent(uid) {
      return getRole(uid) in ["company", "recruiter", "agent"];
    }

    function isJobSeeker(uid) {
      return getRole(uid) == "jobseeker" || getRole(uid) == "seeker" || getRole(uid) == "user";
    }

    // -----------------------------
    // Profiles: public read, owner writes
    // -----------------------------
    match /profiles/{userId} {
      // Profile visibility rules:
      // - public: anyone can read
      // - owner: full read/write
      // - companies/agents: may read profiles regardless of public flag (for hiring workflows)
      allow read: if (
        // explicitly public
        (resource.data.visibility == "public")
        // or owner
        || (isSignedIn() && request.auth.uid == userId)
        // or company/agent viewing
        || (isSignedIn() && isCompanyOrAgent(request.auth.uid))
      );

      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update, delete: if isSignedIn() && request.auth.uid == userId;
    }

    // -----------------------------
    // Folios & Subscriptions: owner-only
    // -----------------------------
    match /folios/{folioId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    match /subscriptions/{subId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // -----------------------------
    // Posts and comments (social feed)
    // - public read
    // - create only by authenticated user with matching authorId
    // - updates/deletes only by owner or admin
    // - comments: public read, create by signed-in users
    // -----------------------------
    match /posts/{postId} {
      // Posts are publicly readable
      allow read: if true;

      // Only authenticated users can create posts
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;

      // Only owner or admin can update/delete posts
      allow update, delete: if isSignedIn() && (resource.data.authorId == request.auth.uid || isAdmin());

      match /comments/{commentId} {
        // Comments are publicly readable
        allow read: if true;
        // Only authenticated users can comment
        allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
        // Only owner or admin can update/delete comments
        allow update, delete: if isSignedIn() && (resource.data.authorId == request.auth.uid || isAdmin());
      }
    }

    // -----------------------------
    // Jobs
    // - public read for listing
    // - create by signed-in users (postedById must match)
    // - updates: only owner/admin (clients cannot directly set counters)
    // - allow safe metric increments for views, likes, and applications
    // -----------------------------
    match /jobs/{jobId} {
      allow read: if true;

      // Only companies/agents may create jobs; postedById must match auth uid
      allow create: if isSignedIn()
        && isCompanyOrAgent(request.auth.uid)
        && request.resource.data.postedById == request.auth.uid
        && request.resource.data.title is string
        && request.resource.data.title.size() <= 300
        && (request.resource.data.media == null || (request.resource.data.media is list && request.resource.data.media.size() <= 10));

      // Owner or admin may update job fields
      allow update: if isSignedIn() && (resource.data.postedById == request.auth.uid || isAdmin());

      // Allow metric-only updates by authenticated users (separate constrained check)
      allow update: if isSignedIn() && (
        (request.resource.data.keys().hasOnly(['views']) && request.resource.data.views is int)
        || (request.resource.data.keys().hasOnly(['likes']) && request.resource.data.likes is int)
        || (request.resource.data.keys().hasOnly(['applies']) && request.resource.data.applies is int)
        || (request.resource.data.keys().hasAny(['views', 'likes', 'applies'])
            && request.resource.data.keys().hasOnly(['views', 'likes', 'applies']))
      );

      allow delete: if isSignedIn() && (resource.data.postedById == request.auth.uid || isAdmin());

      // likes as a subcollection: user may create/delete their own like doc.
      match /likes/{likeUserId} {
        allow create, delete: if isSignedIn() && request.auth.uid == likeUserId;
        allow read: if true;
      }

      // applications subcollection. Applicant may create their application only if they are a jobseeker
      // Applicant or job owner or company/agent may read application documents
      match /applications/{applicationId} {
        allow create: if isSignedIn()
          && isJobSeeker(request.auth.uid)
          && request.resource.data.applicantId == request.auth.uid
          && request.resource.data.jobId == jobId;

        allow read: if isSignedIn() && (
          resource.data.applicantId == request.auth.uid
          || get(/databases/$(database)/documents/jobs/$(jobId)).data.postedById == request.auth.uid
          || isCompanyOrAgent(request.auth.uid)
          || isAdmin()
        );

        // Applicant may update their application (e.g., withdraw). Company/agent or job owner may update status fields.
        allow update: if isSignedIn() && (
          resource.data.applicantId == request.auth.uid
          || get(/databases/$(database)/documents/jobs/$(jobId)).data.postedById == request.auth.uid
          || isCompanyOrAgent(request.auth.uid)
          || isAdmin()
        );

        allow delete: if isSignedIn() && (
          resource.data.applicantId == request.auth.uid
          || get(/databases/$(database)/documents/jobs/$(jobId)).data.postedById == request.auth.uid
          || isAdmin()
        );
      }
    }

    // -----------------------------
    // Generic collectionGroup rules for likes and applications
    // Allow users to create/delete their own likes/applications documents so they can
    // perform collectionGroup queries filtered by user. Parent owners or admins can read
    // applications for their resources via parent checks.
    // -----------------------------
    match /{parent=**}/likes/{likeId} {
      allow create, delete: if isSignedIn() && request.auth.uid == likeId;
      allow read: if true;
    }

    // Generic collectionGroup rule for applications (fallback). Prefer the jobs/{jobId}/applications explicit rules above.
    match /{parent=**}/applications/{applicationId} {
      allow create: if isSignedIn() && request.resource.data.applicantId == request.auth.uid;
      allow read, update, delete: if isSignedIn() && (
        resource.data.applicantId == request.auth.uid
        || (exists(/databases/$(database)/documents/$(parent)) && get(/databases/$(database)/documents/$(parent)).data.postedById == request.auth.uid)
        || isCompanyOrAgent(request.auth.uid)
        || isAdmin()
      );
    }

    // -----------------------------
    // Account approvals
    // -----------------------------
    match /accountApprovals/{approvalId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isSignedIn() && (request.auth.uid == resource.data.userId || isAdmin());
      allow update, delete: if isSignedIn() && isAdmin();
    }

    // -----------------------------
    // Notifications
    // - created only by server (admin SDK)
    // - recipient can read and mark read (update only the `read` boolean)
    // -----------------------------
    match /notifications/{notificationId} {
      allow create: if false; // server functions should create notifications with admin SDK
      allow read: if isSignedIn() && request.auth.uid == resource.data.to;
      // allow marking as read: only change the `read` field and only by recipient
      allow update: if isSignedIn() && request.auth.uid == resource.data.to
        && request.resource.data.keys().hasOnly(['read'])
        && request.resource.data.read is bool;
      allow delete: if false;
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
  