rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helpers
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // -----------------------------
    // Profiles: public read, owner writes
    // -----------------------------
    match /profiles/{userId} {
      allow read: if true;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update, delete: if isSignedIn() && request.auth.uid == userId;
    }

    // -----------------------------
    // Folios & Subscriptions: owner-only
    // -----------------------------
    match /folios/{folioId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    match /subscriptions/{subId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // -----------------------------
    // Posts and comments (social feed)
    // - public read
    // - create only by authenticated user with matching authorId
    // - updates/deletes only by owner or admin
    // - comments: public read, create by signed-in users
    // -----------------------------
    match /posts/{postId} {
      // Posts are publicly readable
      allow read: if true;

      // Only authenticated users can create posts
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;

      // Only owner or admin can update/delete posts
      allow update, delete: if isSignedIn() && (resource.data.authorId == request.auth.uid || isAdmin());

      match /comments/{commentId} {
        // Comments are publicly readable
        allow read: if true;
        // Only authenticated users can comment
        allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
        // Only owner or admin can update/delete comments
        allow update, delete: if isSignedIn() && (resource.data.authorId == request.auth.uid || isAdmin());
      }
    }

    // -----------------------------
    // Jobs
    // - public read for listing
    // - create by signed-in users (postedById must match)
    // - updates: only owner/admin (clients cannot directly set counters)
    // - allow safe view increment (only +1) to help lightweight view metrics
    // -----------------------------
    match /jobs/{jobId} {
      allow read: if true;

      allow create: if isSignedIn()
        && request.resource.data.postedById == request.auth.uid
        && request.resource.data.title is string
        && request.resource.data.title.size() <= 300
        && (request.resource.data.media == null || (request.resource.data.media is list && request.resource.data.media.size() <= 10))
        && (
          // Company jobs must have all required fields
          (request.resource.data.type == "company"
            && request.resource.data.companyName is string
            && request.resource.data.cacNumber is string // or certificateUpload
            && (request.resource.data.certificateUpload is string || request.resource.data.cacNumber is string)
            && request.resource.data.companyEmail is string
            && request.resource.data.officeAddress is string
            && request.resource.data.hrManagerName is string
            && request.resource.data.hrManagerPhone is string
            // websiteOrSocialLink is optional
            && request.resource.data.isActive == true
          )
          // Business jobs must have all required fields
          || (request.resource.data.type == "business"
            && request.resource.data.businessName is string
            && request.resource.data.businessType is string
            && request.resource.data.businessAddress is string
            && request.resource.data.ownerName is string
            && request.resource.data.ownerId is string // NIN/ID/Voter's Card
            && request.resource.data.ownerPhone is string
            // businessLogoOrPhoto is optional
            && request.resource.data.isActive == true
          )
        );

      // Owner or admin may update job fields. Prevent clients from arbitrarily changing counters.
      // Only owner or admin can update/delete jobs
      allow update, delete: if isSignedIn() && (resource.data.postedById == request.auth.uid || isAdmin());

      // Anyone can increment views (public metric)
      allow update: if request.resource.data.keys().hasOnly(['views'])
        && request.resource.data.views is int
        && resource.data.views is int
        && request.resource.data.views == resource.data.views + 1;

      allow delete: if isSignedIn() && (resource.data.postedById == request.auth.uid || isAdmin());

      // likes as a subcollection: user may create/delete their own like doc.
      match /likes/{likeUserId} {
        // Any authenticated user can like/unlike any post/job
        allow create: if isSignedIn();
        allow read: if true;
        allow delete: if isSignedIn() && request.auth.uid == likeUserId;
      }

      // applications subcollection. Applicant may create and read their application.
      // Job owner may read/update application status. Admins may manage.
      match /applications/{applicationId} {
        // Only authenticated users can apply
        allow create: if isSignedIn() && request.resource.data.applicantId == request.auth.uid;
        // Only owner, applicant, or admin can read/update/delete
        allow read, update, delete: if isSignedIn() && (
          resource.data.applicantId == request.auth.uid
          || get(/databases/$(database)/documents/jobs/$(jobId)).data.postedById == request.auth.uid
          || isAdmin()
        );
      }
    }

    // -----------------------------
    // Generic collectionGroup rules for likes and applications
    // Allow users to create/delete their own likes/applications documents so they can
    // perform collectionGroup queries filtered by user. Parent owners or admins can read
    // applications for their resources via parent checks.
    // -----------------------------
    match /{parent=**}/likes/{likeId} {
      // Any authenticated user can like/unlike any post/job
      allow create: if isSignedIn();
      allow read: if true;
      allow delete: if isSignedIn() && request.auth.uid == likeId;
    }

    match /{parent=**}/applications/{applicationId} {
      // Only authenticated users can apply
      allow create: if isSignedIn() && request.resource.data.applicantId == request.auth.uid;
      // Only owner, applicant, or admin can read/update/delete
      allow read, update, delete: if isSignedIn() && (
        resource.data.applicantId == request.auth.uid
        || (exists(/databases/$(database)/documents/$(parent)) && get(/databases/$(database)/documents/$(parent)).data.postedById == request.auth.uid)
        || isAdmin()
      );
    }

    // -----------------------------
    // Account approvals
    // -----------------------------
    match /accountApprovals/{approvalId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isSignedIn() && (request.auth.uid == resource.data.userId || isAdmin());
      allow update, delete: if isSignedIn() && isAdmin();
    }

    // -----------------------------
    // Notifications
    // - created only by server (admin SDK)
    // - recipient can read and mark read (update only the `read` boolean)
    // -----------------------------
    match /notifications/{notificationId} {
      allow create: if false; // server functions should create notifications with admin SDK
      allow read: if isSignedIn() && request.auth.uid == resource.data.to;
      // allow marking as read: only change the `read` field and only by recipient
      allow update: if isSignedIn() && request.auth.uid == resource.data.to
        && request.resource.data.keys().hasOnly(['read'])
        && request.resource.data.read is bool;
      allow delete: if false;
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
  